{% extends 'monitoreo/base.html' %}

{% block content %}
<h2 class="neon-title mt-5" data-aos="fade-up" title="Aqu√≠ se listan todos los eventos registrados autom√°ticamente o manualmente.">
    Sistema de Monitoreo
</h2>

<div class="text-center my-4 d-flex justify-content-center gap-3" data-aos="fade-up">
    <a href="{% url 'agregar_evento' %}" class="btn btn-critical" title="Crea un nuevo evento desde cero.">+ Agregar Evento</a>
    <button onclick="agregarEvento()" class="btn btn-neutral" title="Simula un evento generado por los sensores.">+ Evento Aleatorio</button>
</div>

{% if eventos %}
<div class="table-responsive" data-aos="fade-up">

    <!-- GRAVES -->
    <h4 class="text-start text-danger mt-4">üî¥ Eventos Graves</h4>
    <table class="table table-bordered custom-table">
        <thead>
            <tr class="text-center">
                <th>Tipo</th>
                <th>Criticidad</th>
                <th>Fecha</th>
                <th>Hora</th>
                <th>Dispositivo</th>
            </tr>
        </thead>
        <tbody id="tabla-graves">
            {% for e in eventos %}
                {% if e.criticidad == "grave" %}
                <tr class="text-center evento-critico">
                    <td>‚ö†Ô∏è {{ e.get_tipo_display }}</td>
                    <td>üî¥ Grave</td>
                    <td>{{ e.fecha }}</td>
                    <td>{{ e.hora }}</td>
                    <td>{{ e.dispositivo }}</td>
                </tr>
                {% endif %}
            {% endfor %}
        </tbody>
    </table>

    <!-- MODERADOS -->
    <h4 class="text-start text-warning mt-5">üü° Eventos Moderados</h4>
    <table class="table table-bordered custom-table">
        <thead>
            <tr class="text-center">
                <th>Tipo</th>
                <th>Criticidad</th>
                <th>Fecha</th>
                <th>Hora</th>
                <th>Dispositivo</th>
            </tr>
        </thead>
        <tbody id="tabla-moderados">
            {% for e in eventos %}
                {% if e.criticidad == "moderado" %}
                <tr class="text-center">
                    <td>{{ e.get_tipo_display }}</td>
                    <td>üü° Moderado</td>
                    <td>{{ e.fecha }}</td>
                    <td>{{ e.hora }}</td>
                    <td>{{ e.dispositivo }}</td>
                </tr>
                {% endif %}
            {% endfor %}
        </tbody>
    </table>

    <!-- LEVES -->
    <h4 class="text-start text-success mt-5">üü¢ Eventos Leves</h4>
    <table class="table table-bordered custom-table">
        <thead>
            <tr class="text-center">
                <th>Tipo</th>
                <th>Criticidad</th>
                <th>Fecha</th>
                <th>Hora</th>
                <th>Dispositivo</th>
            </tr>
        </thead>
        <tbody id="tabla-leves">
            {% for e in eventos %}
                {% if e.criticidad == "leve" %}
                <tr class="text-center">
                    <td>{{ e.get_tipo_display }}</td>
                    <td>üü¢ Leve</td>
                    <td>{{ e.fecha }}</td>
                    <td>{{ e.hora }}</td>
                    <td>{{ e.dispositivo }}</td>
                </tr>
                {% endif %}
            {% endfor %}
        </tbody>
    </table>
</div>
{% else %}
<div class="alert alert-warning text-center">No hay eventos registrados.</div>
{% endif %}

<!-- Bot√≥n flotante para mostrar el chatbot -->
<button class="toggle-chatbot" onclick="toggleChatbot()" title="Haz clic aqu√≠ para hablar con Nhyrex, tu asistente virtual.">üí¨ Chat</button>

<!-- Chatbot -->
<div class="chatbot-container" style="display: none;">
    <div class="chatbot-header">Nhyrex ‚Äì Asistente Virtual</div>
    <div class="chatbot-body" id="chatbox">
        <div class="chatbot-message">Hola, soy Nhyrex. ¬øEn qu√© te puedo ayudar?</div>
    </div>
    <div class="chatbot-footer">
        <input type="text" placeholder="Escribe tu mensaje..." class="chatbot-input" id="userInput" onkeydown="if(event.key==='Enter'){responder();}">
        <button class="chatbot-send" onclick="responder()">Enviar</button>
    </div>
</div>

<style>
.custom-table th {
    background-color: #111;
    color: #fff;
    border-color: #333;
}
.custom-table td, .custom-table th {
    vertical-align: middle;
}
.evento-critico {
    border-left: 5px solid #ff0040;
    background-color: #1b0e0e !important;
}
.toggle-chatbot {
    position: fixed;
    bottom: 30px;
    right: 30px;
    z-index: 1000;
    background: linear-gradient(to right, #ff0040, #a000f0);
    color: white;
    border: none;
    padding: 12px 20px;
    border-radius: 50px;
    font-weight: bold;
    cursor: pointer;
    box-shadow: 0 0 10px #ff0040;
}
.chatbot-container {
    position: fixed;
    bottom: 90px;
    right: 30px;
    width: 330px;
    border-radius: 20px;
    background-color: #0c0c0c;
    border: 2px solid #ff0040;
    box-shadow: 0 0 20px rgba(255, 0, 80, 0.5);
    font-family: 'Segoe UI', sans-serif;
    z-index: 1001;
}
.chatbot-header {
    padding: 14px;
    font-weight: bold;
    text-align: center;
    color: white;
    background: linear-gradient(to right, #ff0040, #a000f0);
    font-size: 1rem;
}
.chatbot-body {
    max-height: 250px;
    overflow-y: auto;
    padding: 12px;
    background-color: #111;
    display: flex;
    flex-direction: column;
    gap: 10px;
}
.chatbot-message, .user-message {
    padding: 10px 15px;
    border-radius: 12px;
    max-width: 80%;
    animation: fadeIn 0.2s ease-in;
}
.chatbot-message {
    background-color: #ff0040;
    color: white;
    align-self: flex-start;
}
.user-message {
    background-color: #333;
    color: white;
    align-self: flex-end;
    margin-left: auto;
}
.chatbot-footer {
    display: flex;
    background-color: #1a1a1a;
    border-top: 1px solid #333;
}
.chatbot-input {
    flex: 1;
    padding: 10px;
    border: none;
    background-color: #222;
    color: white;
    outline: none;
}
.chatbot-send {
    background: linear-gradient(to right, #ff0040, #a000f0);
    border: none;
    color: white;
    padding: 10px 16px;
    font-weight: bold;
    cursor: pointer;
}
</style>

<script>
function responder() {
    const input = document.getElementById("userInput");
    const mensaje = input.value.trim();
    if (mensaje === "") return;

    const chatbox = document.getElementById("chatbox");

    const userMsg = document.createElement("div");
    userMsg.className = "user-message";
    userMsg.textContent = mensaje;
    chatbox.appendChild(userMsg);

    fetch("{% url 'chatbot' %}", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": "{{ csrf_token }}"
        },
        body: JSON.stringify({ message: mensaje })
    })
    .then(response => response.json())
    .then(data => {
        const botMsg = document.createElement("div");
        botMsg.className = "chatbot-message";
        botMsg.textContent = data.reply;
        chatbox.appendChild(botMsg);
        chatbox.scrollTop = chatbox.scrollHeight;

        if (data.evento_registrado) {
            agregarFilaEvento(data.evento_registrado);
        }
    });

    input.value = "";
    chatbox.scrollTop = chatbox.scrollHeight;
}

function agregarFilaEvento(evento) {
    const fila = document.createElement("tr");
    fila.className = "text-center";

    let emoji = evento.criticidad === "Grave" ? "üî¥ Grave"
               : evento.criticidad === "Moderado" ? "üü° Moderado"
               : "üü¢ Leve";

    if (evento.criticidad === "Grave") {
        fila.classList.add("evento-critico");
    }

    fila.innerHTML = `
        <td>${evento.tipo === "Ataque" ? "‚ö†Ô∏è " + evento.tipo : evento.tipo}</td>
        <td>${emoji}</td>
        <td>${evento.fecha}</td>
        <td>${evento.hora}</td>
        <td>${evento.dispositivo}</td>
    `;

    const tablaID = evento.criticidad === "Grave" ? "tabla-graves"
                  : evento.criticidad === "Moderado" ? "tabla-moderados"
                  : "tabla-leves";

    const tabla = document.getElementById(tablaID);
    if (tabla) tabla.appendChild(fila);
}

function toggleChatbot() {
    const chatbot = document.querySelector('.chatbot-container');
    chatbot.style.display = chatbot.style.display === 'none' || chatbot.style.display === '' ? 'block' : 'none';
}

document.addEventListener("keydown", function(e) {
    if (e.altKey && e.key.toLowerCase() === "n") {
        e.preventDefault();
        window.location.href = "{% url 'agregar_evento' %}";
    }
    if (e.altKey && e.key.toLowerCase() === "m") {
        e.preventDefault();
        toggleChatbot();
    }
    if (e.key === "Escape") {
        const chatbot = document.querySelector('.chatbot-container');
        if (chatbot && chatbot.style.display === 'block') {
            chatbot.style.display = 'none';
        }
    }
});

function agregarEvento() {
    const tipos = ["Ataque", "Anomal√≠a", "Chequeo General"];
    const criticidades = ["Grave", "Moderado", "Leve"];
    const dispositivos = ["Smartwatch", "Anillo", "Almohada Inteligente"];

    const tipo = tipos[Math.floor(Math.random() * tipos.length)];
    const criticidad = criticidades[Math.floor(Math.random() * criticidades.length)];
    const dispositivo = dispositivos[Math.floor(Math.random() * dispositivos.length)];

    const fecha = new Date();
    const fechaStr = fecha.toLocaleDateString("es-PE", { year: "numeric", month: "long", day: "numeric" });
    const horaStr = fecha.toLocaleTimeString("es-PE", { hour: "numeric", minute: "2-digit", hour12: true });

    const evento = {
        tipo: tipo,
        criticidad: criticidad,
        fecha: fechaStr,
        hora: horaStr,
        dispositivo: dispositivo
    };

    agregarFilaEvento(evento);
}
</script>


{% endblock %}